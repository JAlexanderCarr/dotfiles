#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
# Install Java (OpenJDK) - optional, controlled by chezmoi config

{{- if not .packages.java }}
echo "[JAVA] Java installation skipped (disabled in config)"
exit 0
{{- end }}

set -euo pipefail

OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"

JAVA_VERSION="21"

# Normalize architecture for Java downloads
JAVA_ARCH="$ARCH"
if [[ "$JAVA_ARCH" == "x86_64" ]]; then
    JAVA_ARCH="x64"
elif [[ "$JAVA_ARCH" == "arm64" || "$JAVA_ARCH" == "aarch64" ]]; then
    JAVA_ARCH="aarch64"
fi

echo "[JAVA] Installing Java (OpenJDK) ${JAVA_VERSION}..."

if [[ "$OS" == "darwin" ]]; then
    # macOS: Prefer Homebrew for OpenJDK
    if ! command -v brew >/dev/null; then
        echo "[JAVA] Homebrew not found. Installing..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    brew install openjdk
elif [[ -f /etc/debian_version ]]; then
    sudo apt-get update -y
    sudo apt-get install -y openjdk-${JAVA_VERSION}-jdk
elif [[ -f /etc/fedora-release ]]; then
    sudo dnf install -y java-latest-openjdk java-latest-openjdk-devel
elif [[ -f /etc/centos-release ]] || [[ -f /etc/redhat-release ]] || [[ -f /etc/system-release ]]; then
    # Try Amazon Linux 2023 / Amazon Linux 2 package first, then fallback to other RHEL-based
    sudo yum install -y java-${JAVA_VERSION}-amazon-corretto-devel 2>/dev/null || \
    sudo yum install -y java-${JAVA_VERSION}-openjdk java-${JAVA_VERSION}-openjdk-devel 2>/dev/null || \
    sudo amazon-linux-extras install -y java-openjdk${JAVA_VERSION} 2>/dev/null || {
        echo "[JAVA] Could not install Java via package manager, installing from tarball..."
        sudo yum install -y wget tar
        cd /tmp
        curl -LO "https://github.com/adoptium/temurin${JAVA_VERSION}-binaries/releases/download/jdk-${JAVA_VERSION}%2B35/OpenJDK${JAVA_VERSION}U-jdk_${JAVA_ARCH}_linux_hotspot_${JAVA_VERSION}_35.tar.gz"
        tar -xzf "OpenJDK${JAVA_VERSION}U-jdk_${JAVA_ARCH}_linux_hotspot_${JAVA_VERSION}_35.tar.gz"
        sudo mkdir -p /usr/lib/jvm
        sudo mv jdk-${JAVA_VERSION}* /usr/lib/jvm/jdk-${JAVA_VERSION}
        sudo alternatives --install /usr/bin/java java /usr/lib/jvm/jdk-${JAVA_VERSION}/bin/java 1
        sudo alternatives --install /usr/bin/javac javac /usr/lib/jvm/jdk-${JAVA_VERSION}/bin/javac 1
        cd ..
        rm -rf OpenJDK${JAVA_VERSION}U-jdk_*.tar.gz
    }
elif [[ -f /etc/arch-release ]]; then
    sudo pacman -Sy --noconfirm jdk-openjdk
else
    echo "[JAVA] Unsupported OS for Java installation."
    exit 1
fi

echo "[JAVA] Java installation complete!"
java -version 2>&1 || echo "[JAVA] Note: You may need to restart your shell to use Java"
